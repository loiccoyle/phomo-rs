(async()=>{var O="/phomo-rs/assets/phomo_wasm_bg-Di2CJYbc.wasm",D=async(e={},t)=>{let n;if(t.startsWith("data:")){const _=t.replace(/^data:.*?base64,/,"");let o;if(typeof Buffer=="function"&&typeof Buffer.from=="function")o=Buffer.from(_,"base64");else if(typeof atob=="function"){const a=atob(_);o=new Uint8Array(a.length);for(let s=0;s<a.length;s++)o[s]=a.charCodeAt(s)}else throw new Error("Cannot decode base64-encoded data URL");n=await WebAssembly.instantiate(o,e)}else{const _=await fetch(t),o=_.headers.get("Content-Type")||"";if("instantiateStreaming"in WebAssembly&&o.startsWith("application/wasm"))n=await WebAssembly.instantiateStreaming(_,e);else{const a=await _.arrayBuffer();n=await WebAssembly.instantiate(a,e)}}return n.instance.exports};let i;function F(e){i=e}const m=new Array(128).fill(void 0);m.push(void 0,null,!0,!1);function r(e){return m[e]}let x=m.length;function N(e){e<132||(m[e]=x,x=e)}function l(e){const t=r(e);return N(e),t}const $=typeof TextDecoder>"u"?(0,module.require)("util").TextDecoder:TextDecoder;let E=new $("utf-8",{ignoreBOM:!0,fatal:!0});E.decode();let A=null;function v(){return(A===null||A.byteLength===0)&&(A=new Uint8Array(i.memory.buffer)),A}function y(e,t){return e=e>>>0,E.decode(v().subarray(e,e+t))}function d(e){x===m.length&&m.push(m.length+1);const t=x;return x=m[t],m[t]=e,t}function T(e){return e==null}let h=null;function c(){return(h===null||h.buffer.detached===!0||h.buffer.detached===void 0&&h.buffer!==i.memory.buffer)&&(h=new DataView(i.memory.buffer)),h}let p=0;const L=typeof TextEncoder>"u"?(0,module.require)("util").TextEncoder:TextEncoder;let M=new L("utf-8");const R=typeof M.encodeInto=="function"?function(e,t){return M.encodeInto(e,t)}:function(e,t){const n=M.encode(e);return t.set(n),{read:e.length,written:n.length}};function k(e,t,n){if(n===void 0){const f=M.encode(e),b=t(f.length,1)>>>0;return v().subarray(b,b+f.length).set(f),p=f.length,b}let _=e.length,o=t(_,1)>>>0;const a=v();let s=0;for(;s<_;s++){const f=e.charCodeAt(s);if(f>127)break;a[o+s]=f}if(s!==_){s!==0&&(e=e.slice(s)),o=n(o,_,_=s+e.length*3,1)>>>0;const f=v().subarray(o+s,o+_),b=R(e,f);s+=b.written,o=n(o,_,s,1)>>>0}return p=s,o}function j(e){const t=typeof e;if(t=="number"||t=="boolean"||e==null)return`${e}`;if(t=="string")return`"${e}"`;if(t=="symbol"){const o=e.description;return o==null?"Symbol":`Symbol(${o})`}if(t=="function"){const o=e.name;return typeof o=="string"&&o.length>0?`Function(${o})`:"Function"}if(Array.isArray(e)){const o=e.length;let a="[";o>0&&(a+=j(e[0]));for(let s=1;s<o;s++)a+=", "+j(e[s]);return a+="]",a}const n=/\[object ([^\]]+)\]/.exec(toString.call(e));let _;if(n.length>1)_=n[1];else return toString.call(e);if(_=="Object")try{return"Object("+JSON.stringify(e)+")"}catch{return"Object"}return e instanceof Error?`${e.name}: ${e.message}
${e.stack}`:_}function V(e,t){const n=t(e.length*1,1)>>>0;return v().set(e,n/1),p=e.length,n}function C(e,t){e=e>>>0;const n=c(),_=[];for(let o=e;o<e+4*t;o+=4)_.push(l(n.getUint32(o,!0)));return _}function S(e,t){try{return e.apply(this,t)}catch(n){i.__wbindgen_export_3(d(n))}}const U=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>i.__wbg_mosaic_free(e>>>0,1));class G{__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,U.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_mosaic_free(t,0)}constructor(t,n,_,o,a){try{const u=i.__wbindgen_add_to_stack_pointer(-16),w=V(t,i.__wbindgen_export_0),I=p;i.mosaic_new(u,w,I,d(n),_,o,T(a)?2:a);var s=c().getInt32(u+4*0,!0),f=c().getInt32(u+4*1,!0),b=c().getInt32(u+4*2,!0);if(b)throw l(f);return this.__wbg_ptr=s>>>0,U.register(this,this.__wbg_ptr,this),this}finally{i.__wbindgen_add_to_stack_pointer(16)}}equalize(){i.mosaic_equalize(this.__wbg_ptr)}transferMasterToTiles(){i.mosaic_transferMasterToTiles(this.__wbg_ptr)}transferTilesToMaster(){try{const _=i.__wbindgen_add_to_stack_pointer(-16);i.mosaic_transferTilesToMaster(_,this.__wbg_ptr);var t=c().getInt32(_+4*0,!0),n=c().getInt32(_+4*1,!0);if(n)throw l(t)}finally{i.__wbindgen_add_to_stack_pointer(16)}}build(t){let n,_;try{const w=i.__wbindgen_add_to_stack_pointer(-16),I=k(t,i.__wbindgen_export_0,i.__wbindgen_export_1),W=p;i.mosaic_build(w,this.__wbg_ptr,I,W);var o=c().getInt32(w+4*0,!0),a=c().getInt32(w+4*1,!0),s=c().getInt32(w+4*2,!0),f=c().getInt32(w+4*3,!0),b=o,u=a;if(f)throw b=0,u=0,l(s);return n=b,_=u,y(b,u)}finally{i.__wbindgen_add_to_stack_pointer(16),i.__wbindgen_export_2(n,_,1)}}getTiles(){try{const s=i.__wbindgen_add_to_stack_pointer(-16);i.mosaic_getTiles(s,this.__wbg_ptr);var t=c().getInt32(s+4*0,!0),n=c().getInt32(s+4*1,!0),_=c().getInt32(s+4*2,!0),o=c().getInt32(s+4*3,!0);if(o)throw l(_);var a=C(t,n).slice();return i.__wbindgen_export_2(t,n*4,4),a}finally{i.__wbindgen_add_to_stack_pointer(16)}}getMaster(){let t,n;try{const u=i.__wbindgen_add_to_stack_pointer(-16);i.mosaic_getMaster(u,this.__wbg_ptr);var _=c().getInt32(u+4*0,!0),o=c().getInt32(u+4*1,!0),a=c().getInt32(u+4*2,!0),s=c().getInt32(u+4*3,!0),f=_,b=o;if(s)throw f=0,b=0,l(a);return t=f,n=b,y(f,b)}finally{i.__wbindgen_add_to_stack_pointer(16),i.__wbindgen_export_2(t,n,1)}}buildBlueprint(t){try{const a=i.__wbindgen_add_to_stack_pointer(-16),s=k(t,i.__wbindgen_export_0,i.__wbindgen_export_1),f=p;i.mosaic_buildBlueprint(a,this.__wbg_ptr,s,f);var n=c().getInt32(a+4*0,!0),_=c().getInt32(a+4*1,!0),o=c().getInt32(a+4*2,!0);if(o)throw l(_);return l(n)}finally{i.__wbindgen_add_to_stack_pointer(16)}}renderBlueprint(t){let n,_;try{const w=i.__wbindgen_add_to_stack_pointer(-16);i.mosaic_renderBlueprint(w,this.__wbg_ptr,d(t));var o=c().getInt32(w+4*0,!0),a=c().getInt32(w+4*1,!0),s=c().getInt32(w+4*2,!0),f=c().getInt32(w+4*3,!0),b=o,u=a;if(f)throw b=0,u=0,l(s);return n=b,_=u,y(b,u)}finally{i.__wbindgen_add_to_stack_pointer(16),i.__wbindgen_export_2(n,_,1)}}}function J(e){l(e)}function H(e,t){const n=new Error(y(e,t));return d(n)}function P(e){const t=r(e);return typeof t=="object"&&t!==null}function Y(e,t){const n=r(e)[r(t)];return d(n)}function K(e){return r(e)===void 0}function Q(e,t){return r(e) in r(t)}function X(e){return typeof r(e)=="bigint"}function Z(e,t){const n=r(t),_=typeof n=="bigint"?n:void 0;c().setBigInt64(e+8*1,T(_)?BigInt(0):_,!0),c().setInt32(e+4*0,!T(_),!0)}function ee(e){const t=BigInt.asUintN(64,e);return d(t)}function te(e,t){return r(e)===r(t)}function ne(e){return Number.isSafeInteger(r(e))}function _e(e){return+r(e)}function re(e,t){const n=y(e,t);return d(n)}function oe(e){console.error(r(e))}function ie(e){return r(e).length}function se(e,t){const n=r(e)[t>>>0];return d(n)}function ce(e){const t=new Uint8Array(r(e));return d(t)}function ae(){const e=new Object;return d(e)}function fe(){const e=new Array;return d(e)}function be(e){return d(e)}function ue(e,t,n){r(e)[l(t)]=l(n)}function de(e,t,n){r(e)[t>>>0]=l(n)}function ge(e){return Array.isArray(r(e))}function we(){return d(Symbol.iterator)}function le(){return S(function(e,t){const n=Reflect.get(r(e),r(t));return d(n)},arguments)}function me(e){return typeof r(e)=="function"}function pe(){return S(function(e,t){const n=r(e).call(r(t));return d(n)},arguments)}function ye(e){const t=r(e).next;return d(t)}function he(){return S(function(e){const t=r(e).next();return d(t)},arguments)}function Te(e){return r(e).done}function Ie(e){const t=r(e).value;return d(t)}function xe(){const e=new Error;return d(e)}function ve(e,t){const n=r(t).stack,_=k(n,i.__wbindgen_export_0,i.__wbindgen_export_1),o=p;c().setInt32(e+4*1,o,!0),c().setInt32(e+4*0,_,!0)}function ke(e,t){let n,_;try{n=e,_=t,console.error(y(e,t))}finally{i.__wbindgen_export_2(n,_,1)}}function Ae(e){return r(e).length}function Me(){const e=i.memory;return d(e)}function Be(e){const t=r(e).buffer;return d(t)}function je(e,t,n){r(e).set(r(t),n>>>0)}function Se(e,t){return r(e)==r(t)}function Ue(e){const t=r(e);return typeof t=="boolean"?t?1:0:2}function Ee(e,t){const n=r(t),_=typeof n=="number"?n:void 0;c().setFloat64(e+8*1,T(_)?0:_,!0),c().setInt32(e+4*0,!T(_),!0)}function qe(e,t){const n=r(t),_=typeof n=="string"?n:void 0;var o=T(_)?0:k(_,i.__wbindgen_export_0,i.__wbindgen_export_1),a=p;c().setInt32(e+4*1,a,!0),c().setInt32(e+4*0,o,!0)}function ze(e){let t;try{t=r(e) instanceof Uint8Array}catch{t=!1}return t}function We(e){let t;try{t=r(e) instanceof ArrayBuffer}catch{t=!1}return t}function Oe(e){const t=r(e);return d(t)}function De(e,t){throw new Error(y(e,t))}function Fe(e,t){const n=j(r(t)),_=k(n,i.__wbindgen_export_0,i.__wbindgen_export_1),o=p;c().setInt32(e+4*1,o,!0),c().setInt32(e+4*0,_,!0)}function Ne(e,t,n,_){console.error(r(e),r(t),r(n),r(_))}function $e(e,t,n,_){console.warn(r(e),r(t),r(n),r(_))}function Le(e,t,n,_){console.info(r(e),r(t),r(n),r(_))}function Re(e,t,n,_){console.log(r(e),r(t),r(n),r(_))}function Ve(e,t,n,_){console.debug(r(e),r(t),r(n),r(_))}URL=globalThis.URL;const g=await D({"./phomo_wasm_bg.js":{__wbindgen_object_drop_ref:J,__wbindgen_error_new:H,__wbindgen_is_object:P,__wbg_getwithrefkey_edc2c8960f0f1191:Y,__wbindgen_is_undefined:K,__wbindgen_in:Q,__wbindgen_is_bigint:X,__wbindgen_bigint_get_as_i64:Z,__wbindgen_bigint_from_u64:ee,__wbindgen_jsval_eq:te,__wbg_isSafeInteger_b9dff570f01a9100:ne,__wbindgen_as_number:_e,__wbindgen_string_new:re,__wbg_error_53abcd6a461f73d8:oe,__wbg_length_f217bbbf7e8e4df4:ie,__wbg_get_5419cf6b954aa11d:se,__wbg_new_fec2611eb9180f95:ce,__wbg_new_e69b5f66fda8f13c:ae,__wbg_new_034f913e7636e987:fe,__wbindgen_number_new:be,__wbg_set_f975102236d3c502:ue,__wbg_set_425e70f7c64ac962:de,__wbg_isArray_6f3b47f09adb61b5:ge,__wbg_iterator_695d699a44d6234c:we,__wbg_get_ef828680c64da212:le,__wbindgen_is_function:me,__wbg_call_a9ef466721e824f2:pe,__wbg_next_13b477da1eaa3897:ye,__wbg_next_b06e115d1b01e10b:he,__wbg_done_983b5ffcaec8c583:Te,__wbg_value_2ab8a198c834c26a:Ie,__wbg_new_abda76e883ba8a5f:xe,__wbg_stack_658279fe44541cf6:ve,__wbg_error_f851667af71bcfc6:ke,__wbg_length_9254c4bd3b9f23c4:Ae,__wbindgen_memory:Me,__wbg_buffer_ccaed51a635d8a2d:Be,__wbg_set_ec2fcf81bc573fd9:je,__wbindgen_jsval_loose_eq:Se,__wbindgen_boolean_get:Ue,__wbindgen_number_get:Ee,__wbindgen_string_get:qe,__wbg_instanceof_Uint8Array_df0761410414ef36:ze,__wbg_instanceof_ArrayBuffer_74945570b4a62ec7:We,__wbindgen_object_clone_ref:Oe,__wbindgen_throw:De,__wbindgen_debug_string:Fe,__wbg_error_4d17c5bb1ca90c94:Ne,__wbg_warn_2e2787d40aad9a81:$e,__wbg_info_1c7fba7da21072d1:Le,__wbg_log_4de37a0274d94769:Re,__wbg_debug_a0b6c2c5ac9a4bfd:Ve}},O),Ce=g.memory,Ge=g.init_panic_hook,Je=g.overlayGrid,He=g.__wbg_mosaic_free,Pe=g.mosaic_new,Ye=g.mosaic_equalize,Ke=g.mosaic_transferMasterToTiles,Qe=g.mosaic_transferTilesToMaster,Xe=g.mosaic_build,Ze=g.mosaic_getTiles,et=g.mosaic_getMaster,tt=g.mosaic_buildBlueprint,nt=g.mosaic_renderBlueprint,_t=g.__wbindgen_export_0,rt=g.__wbindgen_export_1,ot=g.__wbindgen_add_to_stack_pointer,it=g.__wbindgen_export_2,st=g.__wbindgen_export_3,q=g.__wbindgen_start;var ct=Object.freeze({__proto__:null,__wbg_mosaic_free:He,__wbindgen_add_to_stack_pointer:ot,__wbindgen_export_0:_t,__wbindgen_export_1:rt,__wbindgen_export_2:it,__wbindgen_export_3:st,__wbindgen_start:q,init_panic_hook:Ge,memory:Ce,mosaic_build:Xe,mosaic_buildBlueprint:tt,mosaic_equalize:Ye,mosaic_getMaster:et,mosaic_getTiles:Ze,mosaic_new:Pe,mosaic_renderBlueprint:nt,mosaic_transferMasterToTiles:Ke,mosaic_transferTilesToMaster:Qe,overlayGrid:Je});F(ct);q();const z=async e=>{const _=await (await (await fetch(e)).blob()).arrayBuffer();return new Uint8Array(_)};var B=(e=>(e.None="none",e.MasterToTile="masterToTile",e.TileToMaster="tileToMaster",e.Equalize="equalize",e))(B||{});const at=async e=>Promise.all(e.map(t=>z(t)));self.onmessage=async e=>{console.log(e);const{masterImageUrl:t,tileImagesUrls:n,gridWidth:_,gridHeight:o,tileSizingMethod:a,colorMatchingMethod:s}=e.data;console.log(e.data);try{const f=await z(t),b=await at(n),u=new G(f,b,_,o,a);switch(s){case B.MasterToTile:u.transferMasterToTiles();break;case B.TileToMaster:u.transferTilesToMaster();break;case B.Equalize:u.equalize();break}const w=u.buildBlueprint("NormL1"),I=u.renderBlueprint(w);self.postMessage({mosaicTiles:u.getTiles(),mosaicBlueprint:w,mosaicImage:I})}catch(f){let b="An unknown error occurred.";f instanceof Error?b=f.message:typeof f=="string"&&(b=f),self.postMessage({error:b})}}})();